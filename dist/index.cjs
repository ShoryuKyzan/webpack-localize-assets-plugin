"use strict";var K=require("path"),T=require("astring"),G=require("webpack/lib/WebpackError.js"),Ne=require("module"),V=require("webpack"),B=require("assert"),Z=require("acorn"),Q=require("crypto"),q=require("webpack-sources"),Y=require("magic-string");function y(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var ee=y(K),z=y(G),ne=y(V),F=y(B),te=y(Q),oe=y(Y),d="webpack-localize-assets-plugin";const se=Object.prototype.hasOwnProperty;function S(e,n){return se.call(e,n)}function re(e){if(!e)throw new Error("Options are required");if(!e.locales)throw new Error("Locales are required");if(Object.keys(e.locales).length===0)throw new Error("locales must contain at least one locale");if(e.sourceMapForLocales&&e.sourceMapForLocales.some(n=>!S(e.locales,n)))throw new Error("sourceMapForLocales must contain valid locales");if(e.localizeCompiler){if(Object.keys(e.localizeCompiler).length===0)throw new Error("localizeCompiler can't be an empty object");if(e.functionName)throw new Error("Can't use localizeCompiler and also specify functionName")}}const ae=(e,n)=>{const o=e.readFileSync(n).toString();return JSON.parse(o)};function ce({inputFileSystem:e},n){const o={},t=new Set;for(const s in n){if(!S(n,s))continue;const r=n[s];if(typeof r=="string"){const a=ee.default.resolve(r);o[s]=ae(e,a),t.add(a)}else o[s]=r}return{names:Object.keys(o),data:o,paths:t}}const E=e=>T.generate(e,{indent:"",lineEnd:""});function I(e,n,o){const t=n.callNode.arguments.map(E),s=n.callNode.callee.name;return e[s].call(n,t,o)}var H=require;const le=e=>{const[n]=e.version?e.version.split("."):[];return n==="5"},M=e=>"processAssets"in e.hooks,{toConstantDependency:ie}=le(ne.default)?H("webpack/lib/javascript/JavascriptParserHelpers"):H("webpack/lib/ParserHelpers"),ue=(e,n,o)=>{if(M(e)){for(const t of e.chunks){if(t.files.has(n))for(const s of o)t.files.add(s);if(t.auxiliaryFiles.has(n))for(const s of o)t.auxiliaryFiles.add(s)}e.deleteAsset(n)}else{delete e.assets[n];for(const t of e.chunks){const s=t.files.indexOf(n);s>-1&&t.files.splice(s,1,...o)}}},b=(e,n)=>{e.find(t=>t.message===n.message)||e.push(n)},_=(e,n)=>{"addWarning"in e?e.addWarning(n):b(e.warnings,n)},fe=(e,n)=>{"addError"in e?e.addError(n):b(e.errors,n)},de=(e,n,o)=>{for(const t of n){const s=r=>{r.hooks.call.for(t).tap(d,a=>o(t,r,a))};e.hooks.parser.for("javascript/auto").tap(d,s),e.hooks.parser.for("javascript/dynamic").tap(d,s),e.hooks.parser.for("javascript/esm").tap(d,s)}},x=(e,n)=>{M(e)?e.hooks.assetPath.tap(d,n):e.mainTemplate.hooks.assetPath.tap(d,n)},he=(e,n)=>{if(M(e)){const o=e.constructor;e.hooks.processAssets.tap({name:d,stage:o.PROCESS_ASSETS_STAGE_SUMMARIZE-1,additionalAssets:!0},n)}else e.hooks.optimizeAssets.tap(d,n)};function pe(e,n){const o=new Set;return(t,s,r)=>{if(o.has(t))return;o.add(t);const a=e.names.filter(f=>!S(e.data[f],t));if(!(a.length>0))return;const i=r.loc.start,c=new z.default(`[${d}] Missing localization for key "${t}" used in ${s.resource}:${i.line}:${i.column} from locales: ${a.join(", ")}`);if(c){if(n)throw c;_(s,c)}}}const R=(e,n,o)=>{de(e,n,(t,s,r)=>{const{module:a}=s.state,l=r.arguments[0];if(!(r.arguments.length>0&&l.type==="Literal"&&typeof l.value=="string")){const c=r.loc.start;_(a,new z.default(`[${d}] Ignoring confusing usage of localization function "${t}" in ${a.resource}:${c.line}:${c.column}`));return}const i=o({key:l.value,callNode:r,module:a});if(i)return ie(s,i)(r),!0})},W=(e,n,o)=>{const t=pe(e,n.throwOnMissing);return s=>{t(s.key,s.module,s.callNode);for(const r of e.paths)s.module.buildInfo.fileDependencies.add(r);return o(s)}},$=(e,n)=>{const o=[];let t=e.indexOf(n);for(;t>-1;)o.push(t),t=e.indexOf(n,t+1);return o},O=(e,n,o)=>{const t=$(e,n);for(let s=t.length-1;s>=0;s-=1){const r=t[s];e=e.slice(0,r)+o+e.slice(r+n.length)}return e},X=(e,n,o)=>{const{filename:t,chunkFilename:s}=e.outputOptions;return o&&(typeof t=="string"&&F.default(t.includes("[locale]"),"output.filename must include [locale]"),typeof s=="string"&&F.default(s.includes("[locale]"),"output.chunkFilename must include [locale]")),(r,a)=>(typeof r=="function"&&(r=r(a)),r=O(r,"[locale]",n),r)},ge=(e,n,o,t,s,r,a)=>{const[l]=t.names;R(n,r,W(t,o,({key:i,callNode:c,module:f})=>(a==null||a.delete(i),I(s,{callNode:c,resolveKey:(u=i)=>t.data[l][u],emitWarning:u=>_(f,new z.default(u)),emitError:u=>fe(f,new z.default(u))},l)))),x(e,X(e,l))},N=e=>te.default.createHash("sha256").update(e).digest("hex"),L=`_placeholder${N(d).slice(0,8)}`,me=(e,{module:n,key:o,callNode:t})=>{n.buildInfo.localized||(n.buildInfo.localized={}),n.buildInfo.localized[o]||(n.buildInfo.localized[o]=e.names.map(r=>e.data[r][o]));const s=E(t);return`${L}(${s},${L})`},we=e=>{const n=$(e,L),o=[];if(n.length!==0){for(;n.length>0;){const t=n.shift(),s=n.shift(),r=e.slice(t+L.length+1,s-1);o.push({code:r,location:{start:t,end:s+L.length+1}})}return o}},ve=e=>e.replace(/\\(.)/g,"$1"),ze=e=>JSON.stringify(e).slice(1,-1),ke=e=>Z.parseExpressionAt(e,0,{ecmaVersion:"latest"}),ye=(e,n,o,t,s)=>{const{devtool:r}=n.options,a=r&&r.includes("eval"),l=we(e);if(!(!l||l.length===0))return(i,{locale:c})=>{const f=t.data[c];for(const u of l){let{code:v}=u;a&&(v=ve(v));const p=ke(v),m=p.arguments[0].value;let h=I(o,{callNode:p,resolveKey:(g=m)=>f[g],emitWarning:g=>{b(n.warnings,new z.default(g))},emitError:g=>{b(n.errors,new z.default(g))}},c);a&&(h=ze(h)),i.overwrite(u.location.start,u.location.end,h),s==null||s.delete(m)}}},A=`[locale:${N("locale-placeholder").slice(0,8)}]`,P=(e,n)=>O(e,A,n),Se=e=>{const n=$(e,A);if(n.length!==0)return(o,{locale:t})=>{for(const s of n)o.overwrite(s,s+A.length,t)}},Le=e=>e.flatMap(n=>{const{contenthash:o}=n.info;return o!=null?o:[]}),Ae=(e,n)=>{const o=Le(e),t=new Map;for(const s of o)for(const r of n.names)t.set(s+r,N(s+r).slice(0,s.length));return{insertLocalizedContentHash(s,r,a){const{contenthash:l}=r;if(l){const i=c=>{var f;const u=(f=t.get(c+a))!=null?f:c;return s=O(s,c,u),u};r.contenthash=Array.isArray(l)?l.map(i):i(l)}return s},getHashLocations(s){const r=o.map(a=>[a,$(s,a)]);if(r.length!==0)return(a,{locale:l})=>{for(const[i,c]of r){const f=t.get(i+l);for(const u of c)a.overwrite(u,u+i.length,f)}}}}},Me=(e,n,o)=>{const t=new oe.default(e.code);for(const r of n)r(t,e);const s=t.toString();if(o){const r=t.generateMap({source:e.name,includeContent:!0});return new q.SourceMapSource(s,e.name,r,e.code,o,!0)}return new q.RawSource(s)},be=/\.js$/,$e=/\.js\.map$/,Ce=(e,n,o,t,s,r)=>{const a=M(e),l=e.getAssets().filter(c=>c.name.includes(A)||c.info.hotModuleReplacement&&a),i=Ae(l,n);for(const c of l){const{source:f,map:u}=c.source.sourceAndMap(),v=[];if(be.test(c.name)){const p=f.toString(),m=ye(p,e,s,n,t),h=Se(p),g=i.getHashLocations(p);if(a&&c.info.hotModuleReplacement&&!m&&!h&&!g){console.log(`XXX already processed or nothing to do ${c.name}`);continue}for(const k of n.names){if(a&&k!==(r!=null?r:"en-US")&&c.info.hotModuleReplacement){console.log(`XXX skipping non-english/non-hmrlocale locale parsing ${k} ${c.name}`);continue}let w=P(c.name,k);const C={...c.info,locale:k};w=i.insertLocalizedContentHash(w,C,k);const j=Me({name:w,code:p,locale:k},[...m?[m]:[],...h?[h]:[],...g?[g]:[]],u);a&&c.info.hotModuleReplacement?(e.updateAsset(w,j,C),console.log("XXX updating localized asset!",w)):(v.push(w),e.emitAsset(w,j,C),console.log("XXX emitting localized asset!",w))}}else{const p=$e.test(c.name)&&o?o:n.names;for(const m of p){const h=P(c.name,m);v.push(h),e.emitAsset(h,c.source,c.info)}}(!c.info.hotModuleReplacement||!a)&&ue(e,c.name,v)}},Ee=(e,n,o,t,s,r,a)=>{R(n,r,W(t,o,l=>me(t,l))),x(e,X(e,A,!0)),he(e,()=>Ce(e,t,o.sourceMapForLocales||t.names,a,s,o.hmrLocale)),e.hooks.chunkHash.tap(d,(l,i)=>{const f=(e.chunkGraph?e.chunkGraph.getChunkModules(l):l.getModules()).map(u=>u.buildInfo.localized).filter(Boolean);f.length>0&&i.update(JSON.stringify(f))})};function _e(e){const n=new Set;for(const o in e)if(S(e,o))for(const t in e[o])S(e[o],t)&&n.add(t);return n}const Oe=(e,n)=>{const o=_e(n);return e.hooks.afterSeal.tap(d,()=>{if(o.size!==0)for(const t of o){const s=new z.default(`[${d}] Unused string key "${t}"`);e.warnings.push(s)}}),o},U="__";function D(e){const[n]=e;if(e.length>1){let t=E(this.callNode);return t.length>80&&(t=`${t.slice(0,80)}\u2026`),this.emitWarning(`[${d}] Ignoring confusing usage of localization function: ${t})`),n}const o=this.resolveKey();return o?JSON.stringify(o):n}class J{constructor(n){var o,t;re(n),this.options=n,this.localizeCompiler=(t=n.localizeCompiler)!=null?t:{[(o=n.functionName)!=null?o:U]:D}}apply(n){const{options:o,localizeCompiler:t}=this;n.hooks.thisCompilation.tap(d,(s,{normalModuleFactory:r})=>{const a=ce(n,o.locales),l=Object.keys(t),i=o.warnOnUnusedString?Oe(s,a.data):void 0;(a.names.length===1?ge:Ee)(s,r,o,a,t,l,i)})}}J.defaultLocalizeCompiler={[U]:D},module.exports=J;
