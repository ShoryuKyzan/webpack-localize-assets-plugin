"use strict";var T=require("path"),G=require("astring"),V=require("webpack/lib/WebpackError.js"),Ne=require("module"),B=require("webpack"),Z=require("assert"),Q=require("acorn"),X=require("crypto"),q=require("webpack-sources"),Y=require("magic-string");function k(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var ee=k(T),v=k(V),te=k(B),F=k(Z),ne=k(X),oe=k(Y),d="webpack-localize-assets-plugin";const se=Object.prototype.hasOwnProperty;function S(e,t){return se.call(e,t)}function re(e){if(!e)throw new Error("Options are required");if(!e.locales)throw new Error("Locales are required");if(Object.keys(e.locales).length===0)throw new Error("locales must contain at least one locale");if(e.sourceMapForLocales&&e.sourceMapForLocales.some(t=>!S(e.locales,t)))throw new Error("sourceMapForLocales must contain valid locales");if(e.localizeCompiler){if(Object.keys(e.localizeCompiler).length===0)throw new Error("localizeCompiler can't be an empty object");if(e.functionName)throw new Error("Can't use localizeCompiler and also specify functionName")}}const ae=(e,t)=>{const o=e.readFileSync(t).toString();return JSON.parse(o)};function ce({inputFileSystem:e},t){const o={},n=new Set;for(const s in t){if(!S(t,s))continue;const r=t[s];if(typeof r=="string"){const a=ee.default.resolve(r);o[s]=ae(e,a),n.add(a)}else o[s]=r}return{names:Object.keys(o),data:o,paths:n}}const E=e=>G.generate(e,{indent:"",lineEnd:""});function I(e,t,o){const n=t.callNode.arguments.map(E),s=t.callNode.callee.name;return e[s].call(t,n,o)}var H=require;const le=e=>{const[t]=e.version?e.version.split("."):[];return t==="5"},M=e=>"processAssets"in e.hooks,{toConstantDependency:ie}=le(te.default)?H("webpack/lib/javascript/JavascriptParserHelpers"):H("webpack/lib/ParserHelpers"),ue=(e,t,o)=>{if(M(e)){for(const n of e.chunks){if(n.files.has(t))for(const s of o)n.files.add(s);if(n.auxiliaryFiles.has(t))for(const s of o)n.auxiliaryFiles.add(s)}e.deleteAsset(t)}else{delete e.assets[t];for(const n of e.chunks){const s=n.files.indexOf(t);s>-1&&n.files.splice(s,1,...o)}}},b=(e,t)=>{e.find(n=>n.message===t.message)||e.push(t)},_=(e,t)=>{"addWarning"in e?e.addWarning(t):b(e.warnings,t)},fe=(e,t)=>{"addError"in e?e.addError(t):b(e.errors,t)},de=(e,t,o)=>{for(const n of t){const s=r=>{r.hooks.call.for(n).tap(d,a=>o(n,r,a))};e.hooks.parser.for("javascript/auto").tap(d,s),e.hooks.parser.for("javascript/dynamic").tap(d,s),e.hooks.parser.for("javascript/esm").tap(d,s)}},x=(e,t)=>{M(e)?e.hooks.assetPath.tap(d,t):e.mainTemplate.hooks.assetPath.tap(d,t)},he=(e,t)=>{if(M(e)){const o=e.constructor;e.hooks.processAssets.tap({name:d,stage:o.PROCESS_ASSETS_STAGE_SUMMARIZE-1,additionalAssets:!0},t)}else e.hooks.optimizeAssets.tap(d,t)};function pe(e,t){const o=new Set;return(n,s,r)=>{if(o.has(n))return;o.add(n);const a=e.names.filter(f=>!S(e.data[f],n));if(!(a.length>0))return;const i=r.loc.start,c=new v.default(`[${d}] Missing localization for key "${n}" used in ${s.resource}:${i.line}:${i.column} from locales: ${a.join(", ")}`);if(c){if(t)throw c;_(s,c)}}}const R=(e,t,o)=>{de(e,t,(n,s,r)=>{const{module:a}=s.state,l=r.arguments[0];if(!(r.arguments.length>0&&l.type==="Literal"&&typeof l.value=="string")){const c=r.loc.start;_(a,new v.default(`[${d}] Ignoring confusing usage of localization function "${n}" in ${a.resource}:${c.line}:${c.column}`));return}const i=o({key:l.value,callNode:r,module:a});if(i)return ie(s,i)(r),!0})},W=(e,t,o)=>{const n=pe(e,t.throwOnMissing);return s=>{n(s.key,s.module,s.callNode);for(const r of e.paths)s.module.buildInfo.fileDependencies.add(r);return o(s)}},C=(e,t)=>{const o=[];let n=e.indexOf(t);for(;n>-1;)o.push(n),n=e.indexOf(t,n+1);return o},O=(e,t,o)=>{const n=C(e,t);for(let s=n.length-1;s>=0;s-=1){const r=n[s];e=e.slice(0,r)+o+e.slice(r+t.length)}return e},P=(e,t,o)=>{const{filename:n,chunkFilename:s}=e.outputOptions;return o&&(typeof n=="string"&&F.default(n.includes("[locale]"),"output.filename must include [locale]"),typeof s=="string"&&F.default(s.includes("[locale]"),"output.chunkFilename must include [locale]")),(r,a)=>(typeof r=="function"&&(r=r(a)),r=O(r,"[locale]",t),r)},ge=(e,t,o,n,s,r,a)=>{const[l]=n.names;R(t,r,W(n,o,({key:i,callNode:c,module:f})=>(a==null||a.delete(i),I(s,{callNode:c,resolveKey:(u=i)=>n.data[l][u],emitWarning:u=>_(f,new v.default(u)),emitError:u=>fe(f,new v.default(u))},l)))),x(e,P(e,l))},N=e=>ne.default.createHash("sha256").update(e).digest("hex"),L=`_placeholder${N(d).slice(0,8)}`,me=(e,{module:t,key:o,callNode:n})=>{t.buildInfo.localized||(t.buildInfo.localized={}),t.buildInfo.localized[o]||(t.buildInfo.localized[o]=e.names.map(r=>e.data[r][o]));const s=E(n);return`${L}(${s},${L})`},we=e=>{const t=C(e,L),o=[];if(t.length!==0){for(;t.length>0;){const n=t.shift(),s=t.shift(),r=e.slice(n+L.length+1,s-1);o.push({code:r,location:{start:n,end:s+L.length+1}})}return o}},ve=e=>e.replace(/\\(.)/g,"$1"),ze=e=>JSON.stringify(e).slice(1,-1),ke=e=>Q.parseExpressionAt(e,0,{ecmaVersion:"latest"}),ye=(e,t,o,n,s)=>{const{devtool:r}=t.options,a=r&&r.includes("eval"),l=we(e);if(!(!l||l.length===0))return(i,{locale:c})=>{const f=n.data[c];for(const u of l){let{code:w}=u;a&&(w=ve(w));const p=ke(w),m=p.arguments[0].value;let h=I(o,{callNode:p,resolveKey:(g=m)=>f[g],emitWarning:g=>{b(t.warnings,new v.default(g))},emitError:g=>{b(t.errors,new v.default(g))}},c);a&&(h=ze(h)),i.overwrite(u.location.start,u.location.end,h),s==null||s.delete(m)}}},A=`[locale:${N("locale-placeholder").slice(0,8)}]`,U=(e,t)=>O(e,A,t),Se=e=>{const t=C(e,A);if(t.length!==0)return(o,{locale:n})=>{for(const s of t)o.overwrite(s,s+A.length,n)}},Le=e=>e.flatMap(t=>{const{contenthash:o}=t.info;return o!=null?o:[]}),Ae=(e,t)=>{const o=Le(e),n=new Map;for(const s of o)for(const r of t.names)n.set(s+r,N(s+r).slice(0,s.length));return{insertLocalizedContentHash(s,r,a){const{contenthash:l}=r;if(l){const i=c=>{var f;const u=(f=n.get(c+a))!=null?f:c;return s=O(s,c,u),u};r.contenthash=Array.isArray(l)?l.map(i):i(l)}return s},getHashLocations(s){const r=o.map(a=>[a,C(s,a)]);if(r.length!==0)return(a,{locale:l})=>{for(const[i,c]of r){const f=n.get(i+l);for(const u of c)a.overwrite(u,u+i.length,f)}}}}},Me=(e,t,o)=>{const n=new oe.default(e.code);for(const r of t)r(n,e);const s=n.toString();if(o){const r=n.generateMap({source:e.name,includeContent:!0});return new q.SourceMapSource(s,e.name,r,e.code,o,!0)}return new q.RawSource(s)},be=/\.js$/,Ce=/\.js\.map$/,$e=(e,t,o,n,s,r)=>{const a=M(e),l=e.getAssets().filter(c=>c.name.includes(A)||c.info.hotModuleReplacement&&a),i=Ae(l,t);for(const c of l){const{source:f,map:u}=c.source.sourceAndMap(),w=[];if(be.test(c.name)){const p=f.toString(),m=ye(p,e,s,t,n),h=Se(p),g=i.getHashLocations(p);if(a&&c.info.hotModuleReplacement&&!m&&!h&&!g)continue;for(const y of t.names){if(a&&y!==(r!=null?r:"en-US")&&c.info.hotModuleReplacement)continue;let z=U(c.name,y);const $={...c.info,locale:y};z=i.insertLocalizedContentHash(z,$,y);const j=Me({name:z,code:p,locale:y},[...m?[m]:[],...h?[h]:[],...g?[g]:[]],u);a&&c.info.hotModuleReplacement?e.updateAsset(z,j,$):(w.push(z),e.emitAsset(z,j,$))}}else{const p=Ce.test(c.name)&&o?o:t.names;for(const m of p){const h=U(c.name,m);w.push(h),e.emitAsset(h,c.source,c.info)}}(!c.info.hotModuleReplacement||!a)&&ue(e,c.name,w)}},Ee=(e,t,o,n,s,r,a)=>{R(t,r,W(n,o,l=>me(n,l))),x(e,P(e,A,!0)),he(e,()=>$e(e,n,o.sourceMapForLocales||n.names,a,s,o.hmrLocale)),e.hooks.chunkHash.tap(d,(l,i)=>{const f=(e.chunkGraph?e.chunkGraph.getChunkModules(l):l.getModules()).map(u=>u.buildInfo.localized).filter(Boolean);f.length>0&&i.update(JSON.stringify(f))})};function _e(e){const t=new Set;for(const o in e)if(S(e,o))for(const n in e[o])S(e[o],n)&&t.add(n);return t}const Oe=(e,t)=>{const o=_e(t);return e.hooks.afterSeal.tap(d,()=>{if(o.size!==0)for(const n of o){const s=new v.default(`[${d}] Unused string key "${n}"`);e.warnings.push(s)}}),o},D="__";function J(e){const[t]=e;if(e.length>1){let n=E(this.callNode);return n.length>80&&(n=`${n.slice(0,80)}\u2026`),this.emitWarning(`[${d}] Ignoring confusing usage of localization function: ${n})`),t}const o=this.resolveKey();return o?JSON.stringify(o):t}class K{constructor(t){var o,n;re(t),this.options=t,this.localizeCompiler=(n=t.localizeCompiler)!=null?n:{[(o=t.functionName)!=null?o:D]:J}}apply(t){const{options:o,localizeCompiler:n}=this;t.hooks.thisCompilation.tap(d,(s,{normalModuleFactory:r})=>{const a=ce(t,o.locales),l=Object.keys(n),i=o.warnOnUnusedString?Oe(s,a.data):void 0;(a.names.length===1?ge:Ee)(s,r,o,a,n,l,i)})}}K.defaultLocalizeCompiler={[D]:J},module.exports=K;
